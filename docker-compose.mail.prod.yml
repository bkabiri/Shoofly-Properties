name: snoofly-mail

networks:
  snoofly-net:
    external: true

volumes:
  maildata:
  mailstate:
  maillogs:
  roundcube_data:
  caddy_data:
    external: true

services:
  mail:
    image: ghcr.io/docker-mailserver/docker-mailserver:latest
    container_name: mail
    hostname: mail
    domainname: snoofly.co.uk
    restart: unless-stopped
    env_file:
      - .env
    environment:
      ENABLE_SPAMASSASSIN: "0"
      ENABLE_CLAMAV: "0"
      ENABLE_FAIL2BAN: "1"
      ENABLE_POSTGREY: "0"
      ONE_DIR: "1"
      PERMIT_DOCKER: "network"
      TLS_LEVEL: "modern"

      # Certs issued by Caddy for mail.snoofly.co.uk (verify this path matches your Caddy data dir)
      SSL_TYPE: "manual"
      SSL_CERT_PATH: "/mnt/caddy/certificates/acme-v02.api.letsencrypt.org-directory/mail.snoofly.co.uk/mail.snoofly.co.uk.crt"
      SSL_KEY_PATH:  "/mnt/caddy/certificates/acme-v02.api.letsencrypt.org-directory/mail.snoofly.co.uk/mail.snoofly.co.uk.key"

      RELAY_HOST: ""
      SMTP_ONLY: "0"
      ENABLE_OPENDKIM: "0"
    ports:
      - "25:25"    # SMTP in
      - "993:993"  # IMAPS
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    stop_grace_period: 1m
    volumes:
      - maildata:/var/mail
      - mailstate:/var/mail-state
      - maillogs:/var/log/mail
      - ./docker-mailserver/config/:/tmp/docker-mailserver/
      - caddy_data:/mnt/caddy:ro
    networks: [snoofly-net]
    healthcheck:
      test: ["CMD-SHELL", "timeout 3 bash -c '</dev/tcp/127.0.0.1/25' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

  roundcube:
    image: roundcube/roundcubemail:latest
    container_name: roundcube
    restart: unless-stopped
    depends_on:
      - mail
    environment:
      ROUNDCUBE_DEFAULT_HOST: "ssl://mail.snoofly.co.uk"
      ROUNDCUBE_DEFAULT_PORT: "993"

      # Send via SendGrid
      ROUNDCUBE_SMTP_SERVER: "smtp.sendgrid.net"
      ROUNDCUBE_SMTP_PORT: "587"
      ROUNDCUBE_SMTP_USER: "apikey"
      ROUNDCUBE_SMTP_PASS: "${SENDGRID_API_KEY}"
      ROUNDCUBE_SMTP_AUTH_TYPE: "LOGIN"
      ROUNDCUBE_SMTP_AUTH: "true"

      ROUNDCUBE_DES_KEY: "${ROUNDCUBE_DES_KEY:-change-me-24-chars}"
      ROUNDCUBE_PLUGINS: "archive,zipdownload,managesieve,markasjunk"
      UPLOAD_MAX_FILESIZE: "25M"
      MEMORY_LIMIT: "256M"
    volumes:
      - roundcube_data:/var/roundcube
    expose:
      - "80"
    networks: [snoofly-net]
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 10