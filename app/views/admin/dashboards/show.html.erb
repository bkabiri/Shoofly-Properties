<%= render "shared/navbar" %>

<section class="admin-wrap py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <div class="admin-title">Admin Dashboard</div>
      <div class="admin-sub">Manage users, approvals, listings and support</div>
    </div>
    <div class="toolbar">
      <%= link_to "View site", root_path, class: "btn btn-ghost" %>
      <%= link_to "Sign out", destroy_user_session_path, data: { turbo_method: :delete }, class: "btn btn-outline-dark" %>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid mb-4">
    <div class="kpi">
      <div class="label">Active Listings</div>
      <div class="value"><%= @kpis[:active_listings] || 0 %></div>
      <% if @kpis[:active_listings_delta] %>
        <div class="delta delta-up">+<%= @kpis[:active_listings_delta] %>% vs last week</div>
      <% end %>
    </div>
    <div class="kpi">
      <div class="label">Private Sellers</div>
      <div class="value"><%= @kpis[:private_sellers] || 0 %></div>
      <% if @kpis[:private_sellers_delta] %>
        <div class="delta delta-up">+<%= @kpis[:private_sellers_delta] %>%</div>
      <% end %>
    </div>
    <div class="kpi">
      <div class="label">Estate Agents</div>
      <div class="value"><%= @kpis[:estate_agents] || 0 %></div>
      <% if @kpis[:estate_agents_delta] %>
        <div class="delta delta-up">+<%= @kpis[:estate_agents_delta] %>%</div>
      <% end %>
    </div>
    <div class="kpi">
      <div class="label">Open Support Tickets</div>
      <div class="value"><%= @kpis[:open_tickets] || 0 %></div>
      <% if @kpis[:tickets_sla_breach].to_i > 0 %>
        <div class="delta delta-down"><%= @kpis[:tickets_sla_breach] %> breaching SLA</div>
      <% end %>
    </div>
  </div>

  <div class="admin-shell">
    <!-- Sidebar (fixed left column) -->
    <aside class="admin-sidebar" role="tablist" aria-label="Admin navigation">
      <div class="mb-2 text-uppercase small fw-bold text-muted">Navigation</div>

      <button type="button"
              class="side-link active"
              data-bs-toggle="tab"
              data-bs-target="#tab-users"
              role="tab"
              aria-controls="tab-users"
              aria-selected="true">
        <i class="bi bi-people"></i> Users
      </button>

      <button type="button"
              class="side-link"
              data-bs-toggle="tab"
              data-bs-target="#tab-approvals"
              role="tab"
              aria-controls="tab-approvals"
              aria-selected="false">
        <i class="bi bi-shield-check"></i> Approvals
        <% pending_count = (@pending_listings&.size.to_i + @agent_requests&.size.to_i) %>
        <span class="ms-auto chip red"><i class="bi bi-dot"></i> <%= pending_count %></span>
      </button>

      <%= link_to admin_tickets_path,
            class: "side-link #{controller_path == 'admin/tickets' ? 'active' : ''}" do %>
        <i class="bi bi-life-preserver"></i> Support
        <span class="ms-auto chip gray"><%= (@kpis && @kpis[:open_tickets]).to_i %></span>
      <% end %>

      <hr>

      <button type="button"
              class="side-link"
              data-bs-toggle="tab"
              data-bs-target="#tab-audit"
              role="tab"
              aria-controls="tab-audit"
              aria-selected="false">
        <i class="bi bi-clipboard-data"></i> Audit & Logs
      </button>

      <button type="button"
              class="side-link"
              data-bs-toggle="tab"
              data-bs-target="#tab-settings"
              role="tab"
              aria-controls="tab-settings"
              aria-selected="false">
        <i class="bi bi-gear"></i> Settings
      </button>
      <!-- Promo Codes -->
      <button type="button"
        class="side-link"
        data-bs-toggle="tab"
        data-bs-target="#tab-promos"
        role="tab"
        aria-controls="tab-promos"
        aria-selected="false">
        <i class="bi bi-ticket-perforated"></i> Promo Codes
      </button>
    </aside>

    <!-- Main column (always the right column) -->
    <div class="admin-main">
      <div class="tab-content">
        <div id="tab-users" class="tab-pane fade show active" role="tabpanel">
          <%= render "admin/dashboard_sections/all_users" %>
        </div>

        <div id="tab-approvals" class="tab-pane fade" role="tabpanel">
          <%= render "admin/dashboard_sections/approvals" %>
        </div>

        <div id="tab-audit" class="tab-pane fade" role="tabpanel">
          <%= render "admin/dashboard_sections/audit" %>
        </div>

        <div id="tab-settings" class="tab-pane fade" role="tabpanel">
          <%= render "admin/dashboard_sections/settings" %>
        </div>
        <div id="tab-promos" class="tab-pane fade" role="tabpanel" aria-labelledby="tab-promos">
          <%= render "admin/dashboard_sections/promo_codes" %>
        </div>
      </div>
    </div>
  </div>
</section>

<%= render "shared/footer" %>

<script>
  document.addEventListener("turbo:load", () => {
    const $$ = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
    const deactivateAll = () => {
      $$('.admin-main .tab-pane').forEach(p => p.classList.remove('show','active'));
      $$('.admin-sidebar .side-link[role="tab"]').forEach(b => b.classList.remove('active'));
    };

    // Deep link: #tab-approvals etc.
    if (location.hash) {
      const trigger = document.querySelector(`[data-bs-target="${location.hash}"]`);
      if (trigger) bootstrap.Tab.getOrCreateInstance(trigger).show();
    }

    // Keep hash + active styling in sync
    $$('.admin-sidebar .side-link[data-bs-toggle="tab"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        bootstrap.Tab.getOrCreateInstance(btn).show();
      });
      btn.addEventListener('shown.bs.tab', () => {
        const target = btn.getAttribute('data-bs-target');
        if (target) history.replaceState(null, "", target);
        $$('.admin-sidebar .side-link').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
  });
</script>