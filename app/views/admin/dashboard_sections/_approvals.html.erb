<div class="section-card mb-4">
  <div class="section-head">
    <h5 class="mb-0">Listings awaiting approval</h5>
    <span class="chip red">
      <i class="bi bi-hourglass-split"></i>
      <%= @pending_listings&.size || 0 %> pending
    </span>
  </div>

  <div class="table-responsive w-100" style="max-height: 420px; overflow:auto; border-radius:.5rem;">
    <table class="table align-middle mb-0">
      <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
        <tr>
          <th>Title</th>
          <th>Seller</th>
          <th>Submitted</th>
          <th>Status</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% (@pending_listings || []).each do |listing| %>
          <tr>
            <td class="fw-semibold text-truncate" style="max-width: 380px;">
              <%= listing.title %>
            </td>
            <td class="text-muted"><%= listing.user&.email %></td>
            <td class="text-muted"><%= l(listing.created_at, format: :short) %></td>
            <td><span class="chip gray"><%= listing.status.humanize %></span></td>
            <td class="text-end">
              <div class="d-inline-flex gap-1">
                <%= link_to listing_path(listing), target: "_blank",
                            class: "btn btn-sm btn-light",
                            data: { bs_toggle: "tooltip", bs_title: "Preview" } do %>
                  <i class="bi bi-box-arrow-up-right"></i>
                <% end %>

                <%= button_to admin_listing_approve_path(listing),
                              method: :patch,
                              class: "btn btn-sm btn-light text-success",
                              form: { data: { turbo_confirm: "Approve this listing?" } },
                              data: { bs_toggle: "tooltip", bs_title: "Approve" } do %>
                  <i class="bi bi-check2-circle"></i>
                <% end %>

                <%= button_to admin_listing_reject_path(listing),
                              method: :patch,
                              class: "btn btn-sm btn-light text-danger",
                              form: { data: { turbo_confirm: "Reject and notify the seller?" } },
                              data: { bs_toggle: "tooltip", bs_title: "Reject" } do %>
                  <i class="bi bi-x-circle"></i>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>

        <% if (@pending_listings || []).empty? %>
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              No listings awaiting approval.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="section-card">
  <div class="section-head">
    <h5 class="mb-0">Requests to switch to Estate Agent</h5>
    <span class="chip red">
      <i class="bi bi-hourglass-split"></i>
      <%= @agent_requests&.size || 0 %> pending
    </span>
  </div>

  <div class="table-responsive w-100" style="max-height: 420px; overflow:auto; border-radius:.5rem;">
    <table class="table align-middle mb-0">
      <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
        <tr>
          <th>Applicant</th>
          <th>Agency name</th>
          <th>Phone</th>
          <th>Requested</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% (@agent_requests || []).each do |user| %>
          <tr>
            <td class="fw-semibold text-truncate" style="max-width: 260px;"><%= user.full_name.presence || user.email %></td>
            <td class="text-muted"><%= user.estate_agent_name.presence || "—" %></td>
            <td class="text-muted"><%= user.landline_phone.presence || user.mobile_phone.presence || "—" %></td>
            <td class="text-muted"><%= l(user.updated_at, format: :short) %></td>
            <td class="text-end">
              <div class="d-inline-flex gap-1">
                <%= link_to admin_user_path(user),
                            class: "btn btn-sm btn-light",
                            data: { bs_toggle: "tooltip", bs_title: "Profile" } do %>
                  <i class="bi bi-person"></i>
                <% end %>

                <%= button_to admin_agent_requests_approve_path(user_id: user.id),
                              method: :patch,
                              class: "btn btn-sm btn-light text-success",
                              form: { data: { turbo_confirm: "Approve this account as Estate Agent?" } },
                              data: { bs_toggle: "tooltip", bs_title: "Approve switch" } do %>
                  <i class="bi bi-check2-circle"></i>
                <% end %>

                <%= button_to admin_agent_requests_decline_path(user_id: user.id),
                              method: :patch,
                              class: "btn btn-sm btn-light text-danger",
                              form: { data: { turbo_confirm: "Decline this request?" } },
                              data: { bs_toggle: "tooltip", bs_title: "Decline" } do %>
                  <i class="bi bi-x-circle"></i>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>

        <% if (@agent_requests || []).empty? %>
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              No pending agent requests.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>