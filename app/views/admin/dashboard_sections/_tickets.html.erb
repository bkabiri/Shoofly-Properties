<div class="section-card">
  <div class="section-head">
    <h5 class="mb-0">Support Enquiries</h5>

    <div class="toolbar">
      <%= form_with url: admin_dashboard_path, method: :get, local: true,
                    data: { turbo_frame: "tickets_frame" },
                    class: "d-flex gap-2 align-items-center" do %>

        <!-- Status filter -->
        <select name="t_status" class="form-select w-auto"
                data-controller="autosubmit"
                data-action="change->autosubmit#submit">
          <option value="">All</option>
          <option value="open"    <%= "selected" if params[:t_status] == "open" %>>Open</option>
          <option value="pending" <%= "selected" if params[:t_status] == "pending" %>>Pending</option>
          <option value="closed"  <%= "selected" if params[:t_status] == "closed" %>>Closed</option>
        </select>

        <!-- Search subject/requester -->
        <input type="search" name="t_q" value="<%= params[:t_q] %>"
               class="form-control"
               placeholder="Search by subject or requester email"
               data-controller="autosubmit"
               data-action="input->autosubmit#submit"
               data-autosubmit-delay-value="220">

        <button class="btn btn-ghost" type="submit" title="Search">
          <i class="bi bi-search"></i>
        </button>
      <% end %>

      <span class="chip gray"><%= (@tickets || []).size %> shown</span>
      <%= link_to "New ticket", new_admin_ticket_path, class: "btn btn-ghost" %>
    </div>
  </div>

  <%= turbo_frame_tag "tickets_frame" do %>
    <div class="table-responsive" style="max-height: 520px; overflow:auto; border-radius:.5rem;">
      <table class="table align-middle mb-0">
        <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
          <tr>
            <th style="width:90px;">ID</th>
            <th>Subject</th>
            <th>Requester</th>
            <th style="width:120px;">Status</th>
            <th style="width:160px;">Updated</th>
            <th class="text-end" style="width:160px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% (@tickets || []).each do |t| %>
            <tr>
              <td>#<%= t.id %></td>
              <td class="fw-semibold text-truncate" style="max-width: 420px;"><%= t.subject %></td>
              <td class="text-muted"><%= t.user&.email || "â€”" %></td>
              <td>
                <% badge =
                  case t.status.to_s
                  when "open"    then "chip red"
                  when "pending" then "chip gray"
                  else "chip gray"
                  end %>
                <span class="<%= badge %>"><%= t.status.to_s.humanize %></span>
              </td>
              <td class="text-muted"><%= l(t.updated_at, format: :short) %></td>
              <td class="text-end">
                <div class="d-inline-flex gap-1">
                  <%= link_to admin_ticket_path(t),
                              class: "btn btn-sm btn-light",
                              data: { bs_toggle: "tooltip", bs_title: "Open ticket" } do %>
                    <i class="bi bi-box-arrow-up-right"></i>
                  <% end %>

                  <% if t.status.to_s != "closed" %>
                    <%= link_to close_admin_ticket_path(t),
                                data: { turbo_method: :patch, turbo_confirm: "Close this ticket?" },
                                class: "btn btn-sm btn-light",
                                data: { bs_toggle: "tooltip", bs_title: "Close" } do %>
                      <i class="bi bi-check2-circle"></i>
                    <% end %>
                  <% else %>
                    <%= link_to reopen_admin_ticket_path(t),
                                data: { turbo_method: :patch, turbo_confirm: "Reopen this ticket?" },
                                class: "btn btn-sm btn-light",
                                data: { bs_toggle: "tooltip", bs_title: "Reopen" } do %>
                      <i class="bi bi-arrow-counterclockwise"></i>
                    <% end %>
                  <% end %>

                  <%= link_to admin_ticket_path(t),
                              data: { turbo_method: :delete, turbo_confirm: "Delete ticket ##{t.id}?" },
                              class: "btn btn-sm btn-light text-danger",
                              data: { bs_toggle: "tooltip", bs_title: "Delete" } do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <% if (@tickets || []).empty? %>
            <tr><td colspan="6" class="text-center text-muted py-4">No support enquiries.</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>