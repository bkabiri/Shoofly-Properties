<%= render "shared/navbar" %>

<%# ---------- Helpers ---------- %>
<% price_text =
     if @listing.guide_price.present?
       number_to_currency(@listing.guide_price, unit: "£", precision: 0, delimiter: ",")
     else
       "Guide price on request"
     end %>

<%# -------- Normalized values for the new details card -------- %>
<%
  # --- Parking -> display as N+ when possible (3+, 2+, etc.) ---
  if @listing.respond_to?(:parking_display)
    parking_display = @listing.parking_display.to_s
  else
    parking_raw = @listing.try(:parking).to_s
    parking_display =
      case parking_raw.downcase
      when "one", "1"                  then "1+"
      when "two", "2"                  then "2+"
      when "three", "3"                then "3+"
      when "three_plus", "3_plus",
           "three +" , "3plus"         then "3+"
      when "four", "4"                 then "4+"
      else
        parking_raw.present? ? parking_raw.humanize.upcase : "—"
      end
  end

  # --- Garden -> YES/NO (uppercase), fallback to em dash ---
  garden_val = @listing.try(:garden)
  garden_text =
    case garden_val
    when true, "true", "yes", "Yes", 1, "1" then "YES"
    when false, "false", "no", "No", 0, "0" then "NO"
    else
      garden_val.present? ? garden_val.to_s.humanize.upcase : "—"
    end

  # --- Council tax band -> uppercase / em dash ---
  council_tax_text = (@listing.try(:council_tax_band).presence || "—").to_s.upcase

  # --- Optional fields ---
  internet_speed = @listing.try(:broadband).presence&.to_s&.upcase
  gas_supplier   = @listing.try(:gas_supplier).presence&.to_s&.upcase
  elec_supplier  = @listing.try(:electricity_supplier).presence&.to_s&.upcase
%>

<%# Who are we contacting? %>
<%
  seller             = @listing.user
  contact_email      = seller.email
%>

<%# Build gallery list (banner first) %>
<%
  gallery_blobs = []
  gallery_blobs << @listing.banner_image if @listing.banner_image.attached?
  if @listing.gallery_images.attached?
    @listing.gallery_images.each { |b| gallery_blobs << b }
  end
%>

<div class="listing-container">
  <div class="listing-grid">
    <%# ========= MAIN CONTENT ========= %>
    <div class="main-content">
      <%# Hero Section %>
      <div class="creative-listing-header">
        <%# Hero Banner with Overlay Elements %>
        <div class="creative-hero">
          <% if @listing.banner_image.attached? %>
            <%= image_tag @listing.banner_image.variant(resize_to_limit: [2200, 1400]),
                          class: "creative-hero-image",
                          alt: @listing.title %>
          <% else %>
            <div class="creative-hero-image no-image">
              <i class="bi bi-house-door text-white"></i>
            </div>
          <% end %>
          
          <%# Premium Badge - Creative Placement %>
          <div class="creative-premium-badge">
            <i class="bi bi-award"></i>
            <span>Featured</span>
          </div>
          
          <%# Favorite Button - Modern Design %>
          <div class="creative-favorite">
            <%= turbo_frame_tag dom_id(@listing, :fav) do %>
              <%= render "favorites/toggle", listing: @listing %>
            <% end %>
          </div>
        </div>
        
        <%# Compact Info Card - Moved below banner with all details integrated %>
        <div class="creative-info-card">
          <div class="creative-info-content">
            <%# Title Row %>
            <div class="creative-title-row">
              <h1 class="creative-title"><%= @listing.title %></h1>
              <div class="creative-price"><%= price_text %></div>
            </div>
            
            <%# Address %>
            <div class="creative-address">
              <i class="bi bi-geo-alt"></i>
              <%= @listing.address %>
            </div>
            
            <%# Property Features - All integrated in one section %>
            <div class="creative-features">
              <%# Basic property features %>
              <div class="feature-pill">
                <i class="bi bi-house-door"></i>
                <span><%= @listing.property_type&.humanize || "—" %></span>
              </div>
              
              <div class="feature-pill">
                <i class="bi bi-door-closed"></i>
                <span><%= @listing.bedrooms || "—" %> bed<%= @listing.bedrooms.to_i > 1 ? 's' : '' %></span>
              </div>
              
              <div class="feature-pill">
                <i class="bi bi-droplet"></i>
                <span><%= @listing.bathrooms || "—" %> bath<%= @listing.bathrooms.to_i > 1 ? 's' : '' %></span>
              </div>
              
              <% if @listing.receptions.present? %>
                <div class="feature-pill">
                  <i class="bi bi-columns"></i>
                  <span><%= @listing.receptions %> reception<%= @listing.receptions > 1 ? 's' : '' %></span>
                </div>
              <% end %>
              
              <%# Additional features from the details card %>
              <% if @listing.try(:parking).present? %>
                <div class="feature-pill">
                  <i class="bi bi-p-square"></i>
                  <span><%= parking_display %></span>
                </div>
              <% end %>
              
              <% if @listing.try(:garden) == true || garden_text == "YES" %>
                <div class="feature-pill">
                  <i class="bi bi-tree"></i>
                  <span>Garden</span>
                </div>
              <% end %>
              
              <% if council_tax_text != "—" %>
                <div class="feature-pill">
                  <i class="bi bi-receipt"></i>
                  <span>Council Tax: <%= council_tax_text %></span>
                </div>
              <% end %>
              
              <% if internet_speed.present? %>
                <div class="feature-pill">
                  <i class="bi bi-wifi"></i>
                  <span>Internet: <%= internet_speed %></span>
                </div>
              <% end %>
              
              <% if gas_supplier.present? %>
                <div class="feature-pill">
                  <i class="bi bi-fire"></i>
                  <span>Gas: <%= gas_supplier %></span>
                </div>
              <% end %>
              
              <% if elec_supplier.present? %>
                <div class="feature-pill">
                  <i class="bi bi-lightning"></i>
                  <span>Electric: <%= elec_supplier %></span>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# Gallery Thumbnails %>
      <% if gallery_blobs.any? %>
        <div class="gallery-thumbnails">
          <% gallery_blobs.each_with_index do |blob, idx| %>
            <div class="gallery-thumb js-open-gallery" data-index="<%= idx %>">
              <%= image_tag blob.variant(resize_to_fill: [200, 150]), alt: "Photo #{idx + 1}" %>
              <span class="gallery-count"><%= idx + 1 %>/<%= gallery_blobs.size %></span>
            </div>
          <% end %>
        </div>
      <% end %>

      <%# Description Section %>
      <div class="content-section">
        <h2 class="section-title">Property Description</h2>
        <div class="description-content">
          <%= raw @listing.description_raw %>
        </div>
      </div>

      <%# ================= Location (Map + Street View) ================= %>
      <% maps_api_key_present = ENV["GOOGLE_MAPS_API_KEY"].present? %>
      <% display_address =
           @listing.try(:address).presence ||
           [@listing.try(:title), @listing.try(:office_address_line1), @listing.try(:office_city), @listing.try(:office_postcode)]
             .compact.join(", ") %>

      <div class="content-section">
        <h2 class="section-title">Location</h2>

        <% if maps_api_key_present %>
          <div class="row g-3 align-items-stretch">
            <div class="col-md-6">
              <div id="gmap" class="gmap-box rounded-3 border"></div>
            </div>
            <div class="col-md-6">
              <div id="gstreet" class="gstreet-box rounded-3 border"></div>
            </div>
          </div>
        <% else %>
          <div class="alert alert-warning">
            Google Maps is not configured. Set <code>ENV["GOOGLE_MAPS_API_KEY"]</code> to enable Map &amp; Street View.
          </div>
        <% end %>

        <div class="property-address mt-3">
          <i class="bi bi-geo-alt-fill text-danger me-2"></i>
          <%= display_address.presence || "Address not provided" %>
        </div>
      </div>
    </div>

    <%# ========= SIDEBAR ========= %>
    <div class="sidebar">
      <%# Contact Card %>
      <div class="sidebar-card">
        <h3 class="section-title">Contact Agent</h3>

        <div class="agent-info">
          <% if seller.respond_to?(:logo) && seller.logo&.attached? %>
            <%= image_tag(seller.logo.variable? ? seller.logo.variant(resize_to_fill: [80, 80]).processed : seller.logo,
                          alt: "#{seller.try(:estate_agent_name).presence || 'Agent'} logo",
                          class: "agent-logo") %>
          <% end %>

          <div class="agent-details">
            <div class="agent-name">
              <% if seller.respond_to?(:estate_agent?) && seller.estate_agent? %>
                <%= seller.estate_agent_name.presence || "Estate Agent" %>
              <% else %>
                Private Seller
              <% end %>
            </div>
            <div class="agent-type">
              <%= (seller.respond_to?(:estate_agent?) && seller.estate_agent?) ? "Estate Agent" : "Private Seller" %>
            </div>
            <% if seller.respond_to?(:office_address_line1) && seller.office_address_line1.present? %>
              <div class="agent-address">
                <i class="bi bi-geo-alt"></i> <%= [seller.office_address_line1, seller.office_city].compact.join(", ") %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="agent-contact">
          <% if seller.respond_to?(:estate_agent?) && seller.estate_agent? %>
            <div class="contact-info">
              <% if seller.respond_to?(:landline_phone) && seller.landline_phone.present? %>
                <div class="contact-item">
                  <i class="bi bi-telephone"></i> <%= seller.landline_phone %>
                </div>
              <% end %>
              <% if seller.respond_to?(:mobile_phone) && seller.mobile_phone.present? %>
                <div class="contact-item">
                  <i class="bi bi-phone"></i> <%= seller.mobile_phone %>
                </div>
              <% end %>
            </div>
          <% end %>

          <%= button_to "Message Seller",
              conversations_path,
              method: :post,
              params: {
                recipient_id: @listing.user_id, # not required by the controller, but harmless
                listing_id:   @listing.id,
                redirect_to:  dashboard_path(tab: "buying", anchor: "messages")
              },
              class: "btn btn-snoofly-red w-100" %>

          <% if seller.respond_to?(:estate_agent?) && seller.estate_agent? %>
            <div class="text-center mt-2">
              <%= link_to "More properties from this agent",
                          listings_path(q: seller.estate_agent_name.presence || seller.office_city),
                          class: "small text-muted" %>
            </div>
          <% end %>
        </div>
      </div>

      <%# Nearby Amenities %>
      <div class="sidebar-card">
        <h3 class="section-title">Nearby Amenities</h3>

        <div class="mb-3">
          <h4 class="h6 mb-2"><i class="bi bi-train-front text-primary me-2"></i>Transportation</h4>
          <div class="nearby-item">
            <span class="nearby-name">Windsor &amp; Eton Central</span>
            <span class="nearby-distance">0.6 mi</span>
          </div>
          <div class="nearby-item">
            <span class="nearby-name">Windsor &amp; Eton Riverside</span>
            <span class="nearby-distance">0.9 mi</span>
          </div>
          <div class="nearby-item">
            <span class="nearby-name">Datchet Station</span>
            <span class="nearby-distance">1.7 mi</span>
          </div>
        </div>

        <div>
          <h4 class="h6 mb-2"><i class="bi bi-mortarboard text-primary me-2"></i>Education</h4>
          <div class="nearby-item">
            <span class="nearby-name">St George's Primary</span>
            <span class="nearby-distance">0.4 mi</span>
          </div>
          <div class="nearby-item">
            <span class="nearby-name">Long Walk Academy</span>
            <span class="nearby-distance">0.8 mi</span>
          </div>
          <div class="nearby-item">
            <span class="nearby-name">Castle View High</span>
            <span class="nearby-distance">1.3 mi</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%= render "shared/footer" %>
<!-- Snoofly Gallery Modal -->
<div class="modal fade snoofly-gallery" id="galleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl modal-dialog-centered">
    <div class="modal-content bg-black position-relative">

      <!-- Top bar -->
      <div class="sng-topbar d-flex align-items-center justify-content-between">
        <div class="sng-brand d-flex align-items-center gap-2">
          <!-- Snoofly house-heart icon -->
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16" fill="#ff4a5f" aria-hidden="true">
            <path d="M7.293 1.5a1 1 0 0 1 1.414 0L11 3.793V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3.293l2.354 2.353a.5.5 0 0 1-.708.707L8 2.207 1.354 8.853a.5.5 0 1 1-.708-.707z"/>
            <path d="m14 9.293-6-6-6 6V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5zm-6-.811c1.664-1.673 5.825 1.254 0 5.018-5.825-3.764-1.664-6.691 0-5.018"/>
          </svg>
          <span class="sng-title"><%= @listing.title %></span>
  <span class="sng-price"><%= @listing.guide_price  %></span>
        </div>

        <div class="sng-counter-wrap">
          <span id="galleryCounter" class="sng-counter">1/<%= gallery_blobs.size %></span>
        </div>

        <div class="sng-actions d-flex align-items-center gap-2">
          <!-- (optional future) share / download / save -->
          <button type="button" class="btn btn-sng-ghost" data-bs-dismiss="modal" aria-label="Close">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="modal-body p-0">
        <div id="galleryCarousel"
             class="carousel slide"
             data-bs-ride="false"
             data-bs-interval="false"
             data-bs-touch="true"
             data-bs-keyboard="true">
          <div class="carousel-inner">
            <% gallery_blobs.each_with_index do |blob, idx| %>
              <div class="carousel-item <%= 'active' if idx.zero? %>">
                <div class="sng-center">
                  <%= image_tag blob.variant(resize_to_limit: [3000, 2000]),
                                class: "sng-image",
                                draggable: "false",
                                alt: "Photo #{idx + 1}" %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Prev / Next -->
          <button class="carousel-control-prev sng-nav" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev" aria-label="Previous">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </button>
          <button class="carousel-control-next sng-nav" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next" aria-label="Next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </button>

          <!-- Swipe hint -->
          <div class="sng-swipe-hint d-none d-md-flex align-items-center gap-2">
            <i class="bi bi-arrow-left-right"></i> Swipe or use arrows
          </div>
        </div>
      </div>

      <% if gallery_blobs.size > 1 %>
        <!-- Thumb strip (inside modal) -->
        <div class="sng-thumbs d-none d-md-flex align-items-center gap-2">
          <% gallery_blobs.each_with_index do |blob, idx| %>
            <button class="sng-thumb js-open-gallery" data-index="<%= idx %>" type="button" aria-label="Open image <%= idx+1 %>">
              <%= image_tag blob.variant(resize_to_fill: [120, 80]), alt: "Thumb #{idx+1}" %>
            </button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
<script>
(function () {
  let bound = false;

  function initSnooflyGallery() {
    if (bound) return;

    const modalEl    = document.getElementById('galleryModal');
    const carouselEl = document.getElementById('galleryCarousel');
    const counterEl  = document.getElementById('galleryCounter');

    if (!modalEl || !carouselEl) return;

    const modal    = bootstrap.Modal.getOrCreateInstance(modalEl, { backdrop: true });
    const carousel = bootstrap.Carousel.getOrCreateInstance(carouselEl, {
      interval: false, ride: false, touch: true, keyboard: true, wrap: true
    });

    // Launch from page thumbnails or modal thumbs
    document.addEventListener('click', (e) => {
      const trigger = e.target.closest('.js-open-gallery');
      if (!trigger) return;
      const idx = parseInt(trigger.dataset.index || '0', 10);
      carousel.to(idx);
      modal.show();
      updateCounter();
    });

    // Keep counter in sync with slide changes
    function updateCounter() {
      const items = carouselEl.querySelectorAll('.carousel-item');
      const activeIndex = Array.prototype.findIndex.call(items, el => el.classList.contains('active'));
      if (counterEl && activeIndex >= 0) counterEl.textContent = `${activeIndex + 1}/${items.length}`;
    }
    carouselEl.addEventListener('slid.bs.carousel', updateCounter);
    updateCounter();

    // Help touch events reach the carousel
    carouselEl.querySelectorAll('.carousel-item img').forEach(img => {
      img.style.pointerEvents = 'none';
      img.setAttribute('draggable','false');
    });

    // One-time swipe hint
    const hint = modalEl.querySelector('.sng-swipe-hint');
    if (hint && !window.__snooflyHintShown) {
      window.__snooflyHintShown = true;
      hint.classList.add('show-hint');
      setTimeout(() => hint.classList.remove('show-hint'), 2200);
    }

    bound = true;
  }

  document.addEventListener('turbo:load', () => { bound = false; initSnooflyGallery(); });
  document.addEventListener('DOMContentLoaded', initSnooflyGallery);
})();
</script>
<script>
  // Google Maps + Street View (Turbo-safe)
  (function () {
    const address = <%= raw(display_address.to_json) %>;
    const mapsEnabled = <%= maps_api_key_present ? 'true' : 'false' %>;
    if (!mapsEnabled) return;

    function initMap() {
      const mapEl    = document.getElementById("gmap");
      const streetEl = document.getElementById("gstreet");
      if (!mapEl || !streetEl || !window.google || !google.maps) return;

      const map = new google.maps.Map(mapEl, {
        zoom: 16,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });

      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: address }, function (results, status) {
        if (status === "OK" && results[0]) {
          const loc = results[0].geometry.location;
          map.setCenter(loc);
          new google.maps.Marker({ position: loc, map: map, title: address });

          const pano = new google.maps.StreetViewPanorama(streetEl, {
            position: loc,
            pov: { heading: 0, pitch: 0 },
            zoom: 1,
            addressControl: true,
            fullscreenControl: true
          });

          map.setStreetView(pano);
        } else {
          mapEl.innerHTML    = '<div class="p-3 text-muted">Could not locate address on the map.</div>';
          streetEl.innerHTML = '<div class="p-3 text-muted">Street View not available for this address.</div>';
        }
      });
    }

    function whenGoogleReady(cb) {
      if (window.google && google.maps) { cb(); return; }
      let tries = 0;
      const iv = setInterval(() => {
        tries += 1;
        if (window.google && google.maps) { clearInterval(iv); cb(); }
        else if (tries > 50) { clearInterval(iv); }
      }, 100);
    }

    const bindInit = () => whenGoogleReady(initMap);
    document.addEventListener("turbo:load", bindInit);
    document.addEventListener("DOMContentLoaded", bindInit);
  })();
</script>