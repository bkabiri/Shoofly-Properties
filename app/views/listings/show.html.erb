<%= render "shared/navbar" %>

<%# ---------- Helpers ---------- %>
<% price_text =
     if @listing.guide_price.present?
       number_to_currency(@listing.guide_price, unit: "¬£", precision: 0, delimiter: ",")
     else
       "Guide price on request"
     end %>

<%# -------- Normalized values for the new details card -------- %>
<%
  # --- Parking -> display as N+ when possible (3+, 2+, etc.) ---
  if @listing.respond_to?(:parking_display)
    parking_display = @listing.parking_display.to_s
  else
    parking_raw = @listing.try(:parking).to_s
    parking_display =
      case parking_raw.downcase
      when "one", "1"                  then "1+"
      when "two", "2"                  then "2+"
      when "three", "3"                then "3+"
      when "three_plus", "3_plus",
           "three +" , "3plus"         then "3+"
      when "four", "4"                 then "4+"
      else
        parking_raw.present? ? parking_raw.humanize.upcase : "‚Äî"
      end
  end

  # --- Garden -> YES/NO (uppercase), fallback to em dash ---
  garden_val = @listing.try(:garden)
  garden_text =
    case garden_val
    when true, "true", "yes", "Yes", 1, "1" then "YES"
    when false, "false", "no", "No", 0, "0" then "NO"
    else
      garden_val.present? ? garden_val.to_s.humanize.upcase : "‚Äî"
    end

  # --- Council tax band -> uppercase / em dash ---
  council_tax_text = (@listing.try(:council_tax_band).presence || "‚Äî").to_s.upcase

  # --- Optional fields ---
  internet_speed = @listing.try(:broadband).presence&.to_s&.upcase
  gas_supplier   = @listing.try(:gas_supplier).presence&.to_s&.upcase
  elec_supplier  = @listing.try(:electricity_supplier).presence&.to_s&.upcase
%>

<%# Who are we contacting? %>
<%
  seller        = @listing.user
  is_agent      = seller.respond_to?(:company_name) && seller.company_name.present?
  estate_agent_name = seller.try(:estate_agent_name)
  agent_logo    = seller.try(:logo) # ActiveStorage attachment if present
  contact_email = seller.email
%>

<%# Build gallery list (banner first) %>
<%
  gallery_blobs = []
  gallery_blobs << @listing.banner_image if @listing.banner_image.attached?
  if @listing.gallery_images.attached?
    @listing.gallery_images.each { |b| gallery_blobs << b }
  end
%>

<div class="listing-stage listing-stage--thumbs-below">
  <%# ========= LEFT: hero ========= %>
  <div class="left-col">
    <div class="listing-hero-card">
      <% if @listing.banner_image.attached? %>
        <%= image_tag @listing.banner_image.variant(resize_to_limit: [2200, 1400]),
                      class: "listing-hero-card__img",
                      alt: @listing.title %>
      <% else %>
        <div class="listing-hero-card__img" style="background:#e9eef5;"></div>
      <% end %>

      <!-- Premium badge (top-right) -->
      <div class="premium-badge">
        <i class="bi bi-star-fill"></i>
        Premium
      </div>

      <!-- Floating summary (Snoofly red @ 80% opacity) -->
      <div class="summary-float">
        <div class="summary-float__address"><%= @listing.title %></div>
        <div class="summary-float__price"><%= price_text %></div>

        <div class="summary-chips mt-2">
          <span class="chip"><i class="bi bi-house-door"></i><%= @listing.property_type&.humanize || "‚Äî" %></span>
          <span class="chip"><i class="bi bi-bed"></i><%= @listing.bedrooms || "‚Äî" %> beds</span>
          <span class="chip"><i class="bi bi-badge-wc"></i><%= @listing.bathrooms || "‚Äî" %> baths</span>
          <span class="chip">
            <i class="bi bi-collection"></i>
            <% if @listing.receptions.present? %>
              <%= @listing.receptions.to_i == 5 ? "5+" : @listing.receptions %> RECEPTIONS
            <% else %>
              ‚Äî
            <% end %>
          </span>
          <span class="chip"><i class="bi bi-graph-up"></i>EPC: <%= @listing.try(:epc_rating).presence || "‚Äî" %></span>
          <% if @listing.tenure.present? %>
            <span class="chip"><i class="bi bi-shield-check"></i><%= @listing.tenure.humanize %></span>
          <% end %>
        </div>
      </div>

      <!-- Favorite star (bottom-right over banner) -->
      <div class="fav-float-banner">
        <%= turbo_frame_tag dom_id(@listing, :fav) do %>
          <%= render "favorites/toggle", listing: @listing %>
        <% end %>
      </div>
    </div>

    <%# ========= KEY DETAILS CARD UNDER THE BANNER ========= %>
    <div class="card shadow-sm border-0 my-3">
      <div class="card-body py-3">
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">

          <!-- Parking -->
          <div class="col">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-p-square" aria-hidden="true"></i>
              <div class="fs-6"><%= parking_display.to_s.upcase %></div>
            </div>
          </div>

          <!-- Garden -->
          <div class="col">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-tree" aria-hidden="true"></i>
              <div>
                <div class="text-uppercase small text-muted fw-semibold">Garden</div>
                <div class="fs-6"><%= garden_text.to_s.upcase %></div>
              </div>
            </div>
          </div>

          <!-- Council Tax Band -->
          <div class="col">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-info-square" aria-hidden="true"></i>
              <div>
                <div class="text-uppercase small text-muted fw-semibold">Council Tax Band</div>
                <div class="fs-6"><%= council_tax_text.to_s.upcase %></div>
              </div>
            </div>
          </div>

          <%# Internet speed (inline, only if present) %>
          <% if internet_speed.present? %>
            <div class="col">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-speedometer2" aria-hidden="true"></i>
                <div class="fs-6"><%= internet_speed.to_s.upcase %></div>
              </div>
            </div>
          <% end %>

          <%# Energy supplies (inline, only if at least one exists) %>
          <% if gas_supplier.present? || elec_supplier.present? %>
            <div class="col">
              <div class="d-flex align-items-center gap-2">
                <% if gas_supplier.present? %>
                  <i class="bi bi-fire" aria-hidden="true"></i>
                  <span class="fs-6">GAS: <%= gas_supplier.to_s.upcase %></span>
                <% end %>

                <% if gas_supplier.present? && elec_supplier.present? %>
                  <span class="text-muted mx-1">‚Ä¢</span>
                <% end %>

                <% if elec_supplier.present? %>
                  <i class="bi bi-lightning-charge" aria-hidden="true"></i>
                  <span class="fs-6">ELECTRICITY: <%= elec_supplier.to_s.upcase %></span>
                <% end %>
              </div>
            </div>
          <% end %>

        </div>
      </div>
    </div>
    <%# ========= /KEY DETAILS CARD ========= %>

    <%# ========= Thumbnails strip UNDER the banner ========= %>
    <% if gallery_blobs.any? %>
      <div class="thumb-strip">
        <div class="thumb-strip__head">Photos</div>
        <div class="thumb-strip__scroller">
          <% gallery_blobs.each_with_index do |blob, idx| %>
            <div class="thumb js-open-gallery" data-index="<%= idx %>">
              <%= image_tag blob.variant(resize_to_fill: [520, 360]),
                            alt: "Photo #{idx + 1}" %>
              <span class="thumb__pill"><%= idx + 1 %>/<%= gallery_blobs.size %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# ========= Description (full banner width) ========= %>
    <div class="listing-content">
      <h3>Description</h3>
      <div class="mb-4"><%= raw @listing.description_raw %></div>
    </div>

    <%# ========= Location (map) ========= %>
    <div class="listing-map">
      <h3>Location</h3>
      <div class="map-placeholder">
        <!-- Later you can embed a real Google Map iframe using @listing.address -->
        <span>üìç Google Map will go here</span>
      </div>
    </div>
  </div>

  <%# ========= RIGHT: sticky contact + nearby ========= %>
  <aside class="right-rail">
    <div class="position-relative mb-3">
      <!-- Contact card -->
      <div class="card border-0 shadow-sm rm-contact">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
      <div class="flex-grow-1">
        <div class="text-uppercase small text-muted fw-semibold mb-1">Marketed by</div>

        <div class="d-flex flex-column">
          <div class="fw-semibold">
            <% if seller.estate_agent? %>
              <%= seller.estate_agent_name.presence || "Estate Agent" %>
              <% if seller.office_city.present? %>, <%= seller.office_city %><% end %>
            <% else %>
              Private Seller
            <% end %>
          </div>

          <% if seller.estate_agent? && (
                seller.office_address_line1.present? ||
                seller.office_city.present? ||
                seller.office_postcode.present?
              ) %>
            <div class="text-muted small">
              <%= [seller.office_address_line1, seller.office_city, seller.office_postcode].compact_blank.join(", ") %>
            </div>
          <% end %>

          <% if seller.estate_agent? %>
            <%= link_to "More properties from this agent",
                        listings_path(q: seller.estate_agent_name.presence || seller.office_city),
                        class: "small rm-contact-more" %>
          <% end %>
        </div>
      </div>

      <% if seller.estate_agent? && seller.logo.attached? %>
        <div class="flex-shrink-0">
          <%= image_tag seller.logo.variant(resize_to_fill: [180, 110]),
                        alt: "#{seller.estate_agent_name} logo",
                        class: "rm-agent-logo rounded" %>
        </div>
      <% end %>
    </div>

    <% if seller.estate_agent? %>
      <div class="mb-3 small text-muted">
        <% if seller.landline_phone.present? %>
          <div><strong>Landline:</strong> <%= seller.landline_phone %></div>
        <% end %>
        <% if seller.mobile_phone.present? %>
          <div><strong>Mobile:</strong> <%= seller.mobile_phone %></div>
        <% end %>
      </div>
    <% end %>

   <div class="d-grid gap-2 mt-3">
  <%= mail_to contact_email,
              "Message Seller",
              subject: "Enquiry about #{@listing.title}",
              class: "btn btn-snoofly w-100" %>

  
</div>
  
  </div>
</div>
    </div>

    <div class="card shadow-sm border-0 info-card">
      <div class="card-body">
        <h6 class="mb-3 fw-bold">Nearby</h6>

        <div class="nearby-block mb-3">
          <div class="nearby-title"><i class="bi bi-train-front"></i> Nearest stations</div>
          <ul class="nearby-list">
            <li><span class="nearby-name">Windsor &amp; Eton Central</span><span class="nearby-dist">0.6 mi</span></li>
            <li><span class="nearby-name">Windsor &amp; Eton Riverside</span><span class="nearby-dist">0.9 mi</span></li>
            <li><span class="nearby-name">Datchet</span><span class="nearby-dist">1.7 mi</span></li>
          </ul>
        </div>

        <div class="nearby-block">
          <div class="nearby-title"><i class="bi bi-mortarboard-fill"></i> Nearest schools</div>
          <ul class="nearby-list">
            <li><span class="nearby-name">St George‚Äôs Primary</span><span class="nearby-dist">0.4 mi</span></li>
            <li><span class="nearby-name">Long Walk Academy</span><span class="nearby-dist">0.8 mi</span></li>
            <li><span class="nearby-name">Castle View High</span><span class="nearby-dist">1.3 mi</span></li>
          </ul>
        </div>
      </div>
    </div>
  </aside>
</div>

<%= render "shared/footer" %>

<%# ========= Modal carousel ========= %>
<div class="modal fade gallery-modal" id="galleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-black">
      <div class="modal-body p-0">
        <div id="galleryCarousel" class="carousel slide" data-bs-interval="false">
          <div class="carousel-inner">
            <% gallery_blobs.each_with_index do |blob, idx| %>
              <div class="carousel-item <%= 'active' if idx.zero? %>">
                <%= image_tag blob.variant(resize_to_limit: [3000, 2000]),
                              alt: "Photo #{idx + 1}" %>
              </div>
            <% end %>
          </div>

          <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="text-white-50 small">
          <span id="galleryCounter">1/<%= gallery_blobs.size %></span>
        </div>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<script>
  document.addEventListener('DOMContentLoaded', function () {
    const thumbs     = document.querySelectorAll('.js-open-gallery');
    const modalEl    = document.getElementById('galleryModal');
    const carouselEl = document.getElementById('galleryCarousel');
    const counterEl  = document.getElementById('galleryCounter');
    if (!carouselEl) return;

    const carousel = new bootstrap.Carousel(carouselEl, { interval: false, ride: false });

    thumbs.forEach(t => {
      t.addEventListener('click', () => {
        const idx = parseInt(t.getAttribute('data-index') || '0', 10);
        const items = carouselEl.querySelectorAll('.carousel-item');
        items.forEach(i => i.classList.remove('active'));
        if (items[idx]) items[idx].classList.add('active');
        if (counterEl) counterEl.textContent = `${idx+1}/${items.length}`;
        new bootstrap.Modal(modalEl).show();
      });
    });

    carouselEl.addEventListener('slid.bs.carousel', function () {
      const items = carouselEl.querySelectorAll('.carousel-item');
      const activeIndex = Array.prototype.indexOf.call(items, carouselEl.querySelector('.carousel-item.active'));
      if (counterEl) counterEl.textContent = `${activeIndex+1}/${items.length}`;
    });
  });
</script>