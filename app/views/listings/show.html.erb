<%= render "shared/navbar" %>

<%# ---------- Helpers ---------- %>
<% price_text =
     if @listing.guide_price.present?
       number_to_currency(@listing.guide_price, unit: "¬£", precision: 0, delimiter: ",")
     else
       "Guide price on request"
     end %>

<%# Who are we contacting? %>
<%
  seller        = @listing.user
  is_agent      = seller.respond_to?(:company_name) && seller.company_name.present?
  agent_logo    = seller.try(:logo) # ActiveStorage attachment if present
  contact_email = seller.email
%>

<%# Build gallery list (banner first) %>
<%
  gallery_blobs = []
  gallery_blobs << @listing.banner_image if @listing.banner_image.attached?
  if @listing.gallery_images.attached?
    @listing.gallery_images.each { |b| gallery_blobs << b }
  end
%>

<div class="listing-stage listing-stage--thumbs-below">
  <%# ========= LEFT: hero ========= %>
  <div class="left-col">
    <div class="listing-hero-card">
      <% if @listing.banner_image.attached? %>
        <%= image_tag @listing.banner_image.variant(resize_to_limit: [2200, 1400]),
                      class: "listing-hero-card__img",
                      alt: @listing.title %>
      <% else %>
        <div class="listing-hero-card__img" style="background:#e9eef5;"></div>
      <% end %>

      <!-- Premium badge (top-right) -->
      <div class="premium-badge">
        <i class="bi bi-star-fill"></i>
        Premium
      </div>

      <!-- Floating summary (Snoofly red @ 80% opacity) -->
      <div class="summary-float">
        <div class="summary-float__address"><%= @listing.title %></div>
        <div class="summary-float__price"><%= price_text %></div>

        <div class="summary-chips mt-2">
          <span class="chip"><i class="bi bi-house-door"></i><%= @listing.property_type&.humanize || "‚Äî" %></span>
          <span class="chip"><i class="bi bi-bed"></i><%= @listing.bedrooms || "‚Äî" %> beds</span>
          <span class="chip"><i class="bi bi-badge-wc"></i><%= @listing.bathrooms || "‚Äî" %> baths</span>
          <span class="chip"><i class="bi bi-collection"></i><%= @listing.try(:receptions) || "‚Äî" %> receptions</span>
          <span class="chip"><i class="bi bi-graph-up"></i>EPC: <%= @listing.try(:epc_rating).presence || "‚Äî" %></span>
          <% if @listing.tenure.present? %>
            <span class="chip"><i class="bi bi-shield-check"></i><%= @listing.tenure.humanize %></span>
          <% end %>
        </div>
      </div>
    </div>

    <%# ========= Thumbnails strip UNDER the banner ========= %>
    <% if gallery_blobs.any? %>
      <div class="thumb-strip">
        <div class="thumb-strip__head">Photos</div>
        <div class="thumb-strip__scroller">
          <% gallery_blobs.each_with_index do |blob, idx| %>
            <div class="thumb js-open-gallery" data-index="<%= idx %>">
              <%= image_tag blob.variant(resize_to_fill: [520, 360]),
                            alt: "Photo #{idx + 1}" %>
              <span class="thumb__pill"><%= idx + 1 %>/<%= gallery_blobs.size %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# ========= Description (full banner width) ========= %>
    <div class="listing-content">
      <h3>Description</h3>
      <div class="mb-4"><%= raw @listing.description_raw %></div>
    </div>

    <%# ========= Location (map) ========= %>
    <div class="listing-map">
      <h3>Location</h3>
      <div class="map-placeholder">
        <!-- Later you can embed a real Google Map iframe using @listing.address -->
        <span>üìç Google Map will go here</span>
      </div>
    </div>
  </div>

  <%# ========= RIGHT: sticky contact + nearby ========= %>
  <aside class="right-rail">
    <%# Wrap the contact card so we can pin the favorite control above it (top-right) %>
    <div class="position-relative mb-3">

      <!-- Favorite star (floating above the card, top-right) -->
      <div class="show-fav-float">
        <%= turbo_frame_tag dom_id(@listing, :fav) do %>
          <%= render "favorites/toggle", listing: @listing %>
        <% end %>
      </div>

      <!-- Contact card -->
      <div class="card shadow-sm border-0 contact-card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="fw-semibold small text-muted">
              <%= is_agent ? "Agent" : "Private Seller" %>
            </div>
            <% if agent_logo&.attached? %>
              <%= image_tag agent_logo.variant(resize_to_fit: [140, 50]),
                            alt: "Agent logo", class: "img-fluid" %>
            <% end %>
          </div>

          <%= mail_to contact_email,
                      "Message seller",
                      subject: "Enquiry about #{@listing.title}",
                      class: "btn btn-snoofly" %>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 info-card">
      <div class="card-body">
        <h6 class="mb-3 fw-bold">Nearby</h6>

        <div class="nearby-block mb-3">
          <div class="nearby-title"><i class="bi bi-train-front"></i> Nearest stations</div>
          <ul class="nearby-list">
            <li><span class="nearby-name">Windsor &amp; Eton Central</span><span class="nearby-dist">0.6 mi</span></li>
            <li><span class="nearby-name">Windsor &amp; Eton Riverside</span><span class="nearby-dist">0.9 mi</span></li>
            <li><span class="nearby-name">Datchet</span><span class="nearby-dist">1.7 mi</span></li>
          </ul>
        </div>

        <div class="nearby-block">
          <div class="nearby-title"><i class="bi bi-mortarboard-fill"></i> Nearest schools</div>
          <ul class="nearby-list">
            <li><span class="nearby-name">St George‚Äôs Primary</span><span class="nearby-dist">0.4 mi</span></li>
            <li><span class="nearby-name">Long Walk Academy</span><span class="nearby-dist">0.8 mi</span></li>
            <li><span class="nearby-name">Castle View High</span><span class="nearby-dist">1.3 mi</span></li>
          </ul>
        </div>
      </div>
    </div>
  </aside>
</div>

<%= render "shared/footer" %>

<%# ========= Modal carousel ========= %>
<div class="modal fade gallery-modal" id="galleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-black">
      <div class="modal-body p-0">
        <div id="galleryCarousel" class="carousel slide" data-bs-interval="false">
          <div class="carousel-inner">
            <% gallery_blobs.each_with_index do |blob, idx| %>
              <div class="carousel-item <%= 'active' if idx.zero? %>">
                <%= image_tag blob.variant(resize_to_limit: [3000, 2000]),
                              alt: "Photo #{idx + 1}" %>
              </div>
            <% end %>
          </div>

          <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="text-white-50 small">
          <span id="galleryCounter">1/<%= gallery_blobs.size %></span>
        </div>
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const thumbs     = document.querySelectorAll('.js-open-gallery');
    const modalEl    = document.getElementById('galleryModal');
    const carouselEl = document.getElementById('galleryCarousel');
    const counterEl  = document.getElementById('galleryCounter');
    if (!carouselEl) return;

    const carousel = new bootstrap.Carousel(carouselEl, { interval: false, ride: false });

    thumbs.forEach(t => {
      t.addEventListener('click', () => {
        const idx = parseInt(t.getAttribute('data-index') || '0', 10);
        const items = carouselEl.querySelectorAll('.carousel-item');
        items.forEach(i => i.classList.remove('active'));
        if (items[idx]) items[idx].classList.add('active');
        if (counterEl) counterEl.textContent = `${idx+1}/${items.length}`;
        new bootstrap.Modal(modalEl).show();
      });
    });

    carouselEl.addEventListener('slid.bs.carousel', function () {
      const items = carouselEl.querySelectorAll('.carousel-item');
      const activeIndex = Array.prototype.indexOf.call(items, carouselEl.querySelector('.carousel-item.active'));
      if (counterEl) counterEl.textContent = `${activeIndex+1}/${items.length}`;
    });
  });
</script>

