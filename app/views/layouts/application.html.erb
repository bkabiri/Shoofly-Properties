<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html>
<head>
  <title>Snoofly</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= action_cable_meta_tag %> <!-- ✅ ADD THIS -->

  <%= yield :head %>

  <%= favicon_link_tag "favicon.ico" %>
  <meta name="stripe-publishable-key" content="<%= ENV.fetch("STRIPE_PUBLIC_KEY") %>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">

  <%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css", media: "all" %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= stylesheet_link_tag "listings_show", media: "all" %>
  <%= stylesheet_link_tag "listings", media: "all" %>
  <script src="https://js.stripe.com/v3" defer></script>
  <%= javascript_include_tag "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js",
                             defer: true,
                             integrity: "sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz",
                             crossorigin: "anonymous" %>
  <%= javascript_include_tag \
        "https://maps.googleapis.com/maps/api/js?key=#{ENV['GOOGLE_MAPS_API_KEY']}&libraries=places&loading=async",
        async: true, defer: true %>

  <%= javascript_importmap_tags %> <!-- ✅ keeps Turbo & controllers -->
</head>
<body>
  <% if session[:admin_id].present? && current_user.present? %>
  <div class="impersonation-banner">
    <div class="container d-flex justify-content-between align-items-center">
      <span>
        <strong>⚠️ Impersonating:</strong> <%= current_user.email %>
      </span>
      <%= link_to "Stop Impersonating",
                  admin_impersonation_path(current_user),
                  data: { turbo_method: :delete },
                  class: "btn btn-sm btn-light fw-bold" %>
    </div>
  </div>
  <% end %>
  <%= yield %>
    <div class="container mt-3">
    <%= render "shared/flash" %>
    </div>
    <script>
    document.addEventListener("turbo:load", () => {
      const flashes = document.querySelectorAll("#flash .alert");
      flashes.forEach(el => {
        setTimeout(() => {
          if (el.classList.contains("show")) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(el);
            bsAlert.close();
          }
        }, 4000);
      });
    });
  </script>
</body>
</html>