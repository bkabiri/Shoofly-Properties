<%= render "shared/navbar" %>

<div class="auth-wrap">
  <div class="container py-5">
    <div class="row justify-content-center g-4">

      <!-- Brand / Benefits panel (left) -->
      <div class="col-12 col-lg-6 d-none d-lg-block">
        <div class="auth-brand card shadow-sm border-0">
          <div class="auth-brand-inner">
            <div class="brand-row mb-2">
              <%= link_to root_path, class: "navbar-brand d-flex align-items-center gap-2" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 16 16" fill="#ff4a5f" aria-hidden="true">
                  <path d="M7.293 1.5a1 1 0 0 1 1.414 0L11 3.793V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3.293l2.354 2.353a.5.5 0 0 1-.708.707L8 2.207 1.354 8.853a.5.5 0 1 1-.708-.707z"/>
                  <path d="m14 9.293-6-6-6 6V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5zm-6-.811c1.664-1.673 5.825 1.254 0 5.018"/>
                </svg>
                <span class="fw-bold fs-4" style="color:#ff4a5f;">Snoofly</span>
              <% end %>
            </div>

            <h2 class="display-6 fw-800 mt-2 mb-2">Secure your account</h2>
            <p class="text-muted mb-4">Choose a strong password you don’t use anywhere else.</p>

            <ul class="list-unstyled auth-benefits">
              <li><i class="bi bi-check-circle-fill"></i> At least 6 characters</li>
              <li><i class="bi bi-check-circle-fill"></i> Mix of letters & numbers</li>
              <li><i class="bi bi-check-circle-fill"></i> Keep your account protected</li>
            </ul>

            <div class="auth-illustration mt-auto">
              <div class="glow"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Set new password form (right) -->
      <div class="col-12 col-lg-6">
        <div class="auth-card card shadow-sm border-0">
          <div class="card-body p-4 p-md-5">

            <div class="text-center mb-4">
              <h1 class="fw-800 mb-1">Set a new password</h1>
              <div class="text-muted">Enter your new password below</div>
            </div>

            <!-- Global error summary (uses full_messages; safe) -->
            <%= render "devise/shared/error_messages", resource: resource %>

            <%= form_for(resource,
                         as: resource_name,
                         url: password_path(resource_name),
                         html: { method: :put, id: "snooflyPwdEditForm", class: "w-100" }) do |f| %>

              <!-- ✅ Ensure token is present as a STRING to avoid bytesize crashes -->
              <%= f.hidden_field :reset_password_token,
                    value: (params[:reset_password_token] || resource.reset_password_token).to_s %>

              <!-- Token-specific friendly error (if invalid/expired) -->
              <% token_msgs = resource.errors.full_messages_for(:reset_password_token) %>
              <% if token_msgs.present? %>
                <div class="alert alert-danger" role="alert">
                  <%= token_msgs.join(", ") %>
                </div>
              <% end %>

              <% pwd_msgs  = resource.errors.full_messages_for(:password) %>
              <% conf_msgs = resource.errors.full_messages_for(:password_confirmation) %>

              <!-- New password -->
              <div class="mb-3">
                <label class="form-label fw-600">New password <span class="text-danger">*</span></label>
                <div class="input-group">
                  <%= f.password_field :password,
                        autocomplete: "new-password",
                        class: ["form-control form-control-lg input-elevated", ("is-invalid" if pwd_msgs.present?)].compact.join(" "),
                        id: "editNewPassword",
                        placeholder: "••••••••" %>
                  <button class="btn btn-outline-secondary btn-eye" type="button" id="toggleEditNewPassword" aria-label="Show password">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                <div class="form-text">Minimum 6 characters.</div>
                <% if pwd_msgs.present? %>
                  <div class="invalid-feedback d-block"><%= pwd_msgs.join(", ") %></div>
                <% end %>
              </div>

              <!-- Confirm new password -->
              <div class="mb-3">
                <label class="form-label fw-600">Confirm new password <span class="text-danger">*</span></label>
                <div class="input-group">
                  <%= f.password_field :password_confirmation,
                        autocomplete: "new-password",
                        class: ["form-control form-control-lg input-elevated", ("is-invalid" if conf_msgs.present?)].compact.join(" "),
                        id: "editNewPasswordConfirm",
                        placeholder: "Repeat your password" %>
                  <button class="btn btn-outline-secondary btn-eye" type="button" id="toggleEditNewPasswordConfirm" aria-label="Show password">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                <% if conf_msgs.present? %>
                  <div class="invalid-feedback d-block"><%= conf_msgs.join(", ") %></div>
                <% end %>
              </div>

              <!-- Submit -->
              <div class="d-grid gap-2 mb-3">
                <%= f.submit "Update password", class: "btn btn-snoofly-red btn-lg" %>
              </div>

              <div class="text-center">
                <%= link_to "Back to log in", new_session_path(resource_name), class: "auth-link" %>
              </div>
            <% end %>
          </div>
        </div>

        <p class="text-center text-muted small mt-3">
          By continuing, you agree to Snoofly’s
          <%= link_to "Terms", "#", class: "auth-link" %> and
          <%= link_to "Privacy Policy", "#", class: "auth-link" %>.
        </p>
      </div>
    </div>
  </div>
</div>

<%= render "shared/footer" %>

<!-- Tiny JS: eye toggles -->
<script>
  document.addEventListener("turbo:load", () => {
    const toggle = (btnId, fieldId) => {
      const btn = document.getElementById(btnId);
      const field = document.getElementById(fieldId);
      if (!btn || !field) return;
      btn.addEventListener("click", () => {
        const isPwd = field.type === "password";
        field.type = isPwd ? "text" : "password";
        btn.querySelector("i")?.classList.toggle("bi-eye");
        btn.querySelector("i")?.classList.toggle("bi-eye-slash");
      });
    };
    toggle("toggleEditNewPassword", "editNewPassword");
    toggle("toggleEditNewPasswordConfirm", "editNewPasswordConfirm");
  });
</script>