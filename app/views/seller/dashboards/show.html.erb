<%= render "shared/navbar" %>

<%# ====================== Setup helpers / fallbacks ====================== %>
<%
  active_tab = (params[:tab].presence_in(%w[buying selling]) || "buying")

  favorites         = (defined?(current_user) && current_user.respond_to?(:saved_listings)) ? current_user.saved_listings.limit(10) : []
  upcoming_viewings = defined?(@upcoming_viewings) ? @upcoming_viewings : []
  sellers_contacted = defined?(@sellers_contacted) ? @sellers_contacted : []
  recent_messages   = defined?(@recent_messages) ? @recent_messages : []
  sellers_from_favs = favorites.respond_to?(:map) ? favorites.map(&:user).uniq : []

  has_approved =
    if defined?(@has_approved_listing)
      @has_approved_listing
    elsif current_user && current_user.respond_to?(:listings)
      (current_user.listings.where(status: %w[published approved active]).exists? rescue false) ||
        current_user.listings.exists?
    else
      false
    end

  display_name = current_user&.full_name.presence || current_user&.email.to_s.split("@").first

  # Support CTA
  support_button_html = if current_user&.admin?
    link_to "New Support Ticket", new_admin_ticket_path, class: "btn btn-sm btn-snoofly"
  else
    mail_to "support@snoofly.com",
            "New Support Ticket",
            subject: "Snoofly support request from #{display_name}",
            class: "btn btn-sm btn-snoofly"
  end
%>

<section class="container py-4">

  <%# ====================== Page Header ====================== %>
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="mb-1 fw-bold">Welcome back, <span class="text-snoofly-primary"><%= display_name %></span></h1>
      <div class="text-muted">Manage your buying and selling activity from one place.</div>
    </div>

    <div class="d-flex align-items-center gap-3">
      <div class="tab-button-group">
        <%= link_to dashboard_path(tab: "buying"),
                    class: "tab-button #{active_tab == 'buying' ? 'active' : ''}" do %>
          <i class="bi bi-house-door"></i> Buying
        <% end %>

        <% if has_approved %>
          <%= link_to dashboard_path(tab: "selling"),
                      class: "tab-button #{active_tab == 'selling' ? 'active' : ''}" do %>
            <i class="bi bi-tag"></i> Selling
          <% end %>
        <% else %>
          <span class="position-relative d-inline-block"
                data-bs-toggle="tooltip"
                title="Post a listing and get approved to unlock the Seller dashboard.">
            <a class="tab-button disabled" href="javascript:void(0)" aria-disabled="true">
              <i class="bi bi-tag"></i> Selling
            </a>
          </span>
        <% end %>
      </div>

      <%# Role toggle %>
      <div class="btn-group role-toggle" role="group" aria-label="Account type">
        <%= button_to "Private Seller",
              switch_to_private_seller_seller_account_path,
              method: :patch,
              form: { data: { turbo: true } },
              class: "btn btn-sm #{current_user&.estate_agent? ? 'btn-outline-dark' : 'btn-dark'}" %>

        <% if current_user&.estate_agent? %>
          <button type="button" class="btn btn-sm btn-dark" disabled>Estate Agent</button>
        <% else %>
          <button type="button"
                  class="btn btn-sm btn-outline-dark"
                  data-bs-toggle="modal"
                  data-bs-target="#agentSwitchModal">
            Estate Agent
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <%# ====================== BUYING TAB ====================== %>
  <% if active_tab == "buying" %>

    <%# Quick summary strip %>
    <div class="row g-3 mb-4">
      <div class="col-6 col-lg-3">
        <div class="dashboard-card card">
          <div class="kpi-card">
            <div class="kpi-value"><%= upcoming_viewings.respond_to?(:size) ? upcoming_viewings.size : 0 %></div>
            <div class="kpi-label">Upcoming Viewings</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="dashboard-card card">
          <div class="kpi-card">
            <div class="kpi-value"><%= sellers_contacted.respond_to?(:size) ? sellers_contacted.size : 0 %></div>
            <div class="kpi-label">Sellers Contacted</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="dashboard-card card">
          <div class="kpi-card">
            <div class="kpi-value"><%= favorites.respond_to?(:size) ? favorites.size : 0 %></div>
            <div class="kpi-label">Favourites</div>
          </div>
        </div>
      </div>
      <div class="col-6 col-lg-3">
        <div class="dashboard-card card">
          <div class="kpi-card">
            <div class="kpi-value"><%= recent_messages.respond_to?(:size) ? recent_messages.size : 0 %></div>
            <div class="kpi-label">New Messages</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <%# Left column – Profile + CTA %>
      <div class="col-lg-4">

        <%# Buyer Profile %>
        <div class="dashboard-card card">
          <div class="dashboard-card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-person me-2"></i> Buyer Profile</span>
            <button class="btn btn-sm btn-outline-secondary" id="editBuyerBtn" type="button">
              <i class="bi bi-pencil"></i> Edit
            </button>
          </div>
          <div class="dashboard-card-body">
            <div id="buyerReadView">
              <div class="d-flex align-items-center mb-4">
                <div class="bg-snoofly-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                     style="width: 60px; height: 60px;">
                  <i class="bi bi-person-fill text-snoofly-primary fs-4"></i>
                </div>
                <div class="ms-3">
                  <h5 class="mb-0"><%= current_user&.full_name.to_s.presence || "Not set" %></h5>
                  <small class="text-muted">Buyer Account</small>
                </div>
              </div>

              <div class="border-top pt-3">
                <div class="mb-3">
                  <div class="text-muted small mb-1"><i class="bi bi-envelope me-1"></i> Email</div>
                  <div class="fw-semibold"><%= current_user&.email.to_s.presence || "—" %></div>
                </div>

                <div class="mb-3">
                  <div class="text-muted small mb-1"><i class="bi bi-telephone me-1"></i> Mobile</div>
                  <div class="fw-semibold"><%= current_user&.mobile_phone.to_s.presence || "Not provided" %></div>
                </div>

                <% if current_user.try(:buyer_type).present? %>
                  <div class="mb-1">
                    <div class="text-muted small mb-1"><i class="bi bi-person-badge me-1"></i> Buyer Type</div>
                    <div class="fw-semibold"><%= current_user.try(:buyer_type).to_s.humanize %></div>
                  </div>
                <% end %>
              </div>
            </div>

            <div id="buyerEditForm" class="d-none">
              <%= form_with model: current_user,
                            url: user_registration_path,
                            method: :put,
                            local: true,
                            data: { turbo: false },
                            class: "mt-3" do |f| %>

                <% if current_user.errors.any? %>
                  <div class="alert alert-danger">
                    <ul class="mb-0">
                      <% current_user.errors.full_messages.each do |msg| %>
                        <li><%= msg %></li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>

                <div class="mb-3">
                  <%= f.label :full_name, "Full name", class: "form-label small text-muted" %>
                  <%= f.text_field :full_name, class: "form-control", autocomplete: "name" %>
                </div>

                <div class="mb-3">
                  <%= f.label :email, "Email", class: "form-label small text-muted" %>
                  <%= f.email_field :email, class: "form-control", autocomplete: "email" %>
                </div>

                <div class="mb-3">
                  <%= f.label :mobile_phone, "Mobile", class: "form-label small text-muted" %>
                  <%= f.telephone_field :mobile_phone, class: "form-control", autocomplete: "tel" %>
                </div>

                <div class="d-flex gap-2 mt-4">
                  <%= f.submit "Save Changes", class: "btn btn-snoofly flex-grow-1" %>
                  <button type="button" class="btn btn-outline-secondary" id="cancelBuyerEdit">Cancel</button>
                </div>
              <% end %>
              <div class="form-text mt-3 text-center">We’ll use these details when sellers contact you.</div>
            </div>
          </div>
        </div>

        <%# CTA to Sell %>
        <div class="dashboard-card card border-0 mt-4"
             style="background: linear-gradient(135deg, #3a86ff 0%, #5c6bc0 100%);">
          <div class="card-body text-white p-4">
            <div class="d-flex align-items-start justify-content-between">
              <div>
                <h5 class="fw-bold mb-1">Ready to sell?</h5>
                <p class="mb-3 opacity-75">List your property and connect with serious buyers.</p>
                <%= link_to "Create New Listing", new_seller_listing_path, class: "btn btn-light btn-sm px-3" %>
              </div>
              <i class="bi bi-megaphone fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
      </div>

      <%# Right column – Favourites + Messages %>
      <div class="col-lg-8">
        <div class="dashboard-card card mb-4">
          <div class="dashboard-card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-heart me-2"></i> Favourite Properties</span>
            <span class="text-muted small">Click the ★ to toggle</span>
          </div>
          <div class="dashboard-card-body p-0">
            <% if favorites.present? %>
              <div class="list-group list-group-flush">
                <% favorites.each do |listing| %>
                  <% price_text = listing.guide_price.present? ?
                       number_to_currency(listing.guide_price, unit: "£", precision: 0, delimiter: ",") :
                       "Guide price on request" %>

                  <div class="list-group-item border-0 p-4">
                    <div class="row g-3 align-items-center">
                      <div class="col-12 col-md-3 col-lg-3">
                        <% if listing.banner_image&.attached? %>
                          <%= image_tag(
                                (listing.banner_image.variable? ?
                                   listing.banner_image.variant(resize_to_fill: [360, 220]).processed :
                                   listing.banner_image),
                                class: "property-thumb", alt: listing.title
                              ) %>
                        <% else %>
                          <div class="property-thumb bg-light d-flex align-items-center justify-content-center text-muted">
                            <i class="bi bi-image fs-1"></i>
                          </div>
                        <% end %>
                      </div>

                      <div class="col-md-7 col-lg-7">
                        <h5 class="mb-1">
                          <%= link_to listing.title, listing_path(listing), class: "text-decoration-none text-dark" %>
                        </h5>
                        <div class="text-muted mb-2">
                          <i class="bi bi-geo-alt me-1"></i><%= listing.address %>
                        </div>
                        <div class="h5 text-snoofly-primary mb-3"><%= price_text %></div>

                        <div class="d-flex flex-wrap gap-3 small text-muted mb-3">
                          <% if listing.property_type.present? %>
                            <span><i class="bi bi-house-door me-1"></i><%= listing.property_type.humanize %></span>
                          <% end %>
                          <% if listing.bedrooms.present? %>
                            <span><i class="bi bi-door-closed me-1"></i><%= listing.bedrooms %> beds</span>
                          <% end %>
                          <% if listing.bathrooms.present? %>
                            <span><i class="bi bi-droplet me-1"></i><%= listing.bathrooms %> baths</span>
                          <% end %>
                        </div>

                        <div class="property-actions">
                          <%= mail_to listing.user.email,
                                      "Message Seller",
                                      subject: "Enquiry about #{listing.title}",
                                      class: "btn btn-outline-dark btn-sm" %>
                          <%= link_to "View Details", listing_path(listing), class: "btn btn-snoofly btn-sm" %>
                        </div>
                      </div>

                      <div class="col-md-2 col-lg-2 text-end">
                        <%= turbo_frame_tag dom_id(listing, :fav) do %>
                          <%= render "favorites/toggle", listing: listing %>
                        <% end %>
                      </div>
                    </div>
                  </div>

                  <% unless listing == favorites.last %>
                    <hr class="my-0">
                  <% end %>
                <% end %>
              </div>
            <% else %>
              <div class="empty-state">
                <i class="bi bi-heart"></i>
                <h5 class="text-muted">No favourites yet</h5>
                <p class="text-muted">Tap the ★ on a listing to save it here.</p>
                <%= link_to "Browse Properties", listings_path, class: "btn btn-snoofly mt-2" %>
              </div>
            <% end %>
          </div>
        </div>

        <%# =================== Contacts & Messages (chat) =================== %>
      <!-- Seller dashboard – Messages card -->
<div class="dashboard-card mb-4" id="messages">
  <div class="dashboard-card-body">
    <!-- Fixed-height pane; tweak --chat-h: -->
    <div class="chat-pane" style="--chat-h: 72vh;">
      <div class="chat-grid">
        <!-- Sidebar (recent chats) -->
        <aside class="chat-sidebar">
          <%= render "conversations/sidebar",
                     conversations: @conversations,
                     open_conversation: @open_conversation %>
        </aside>

        <!-- Main thread -->
        <section class="chat-main">
          <% if @open_conversation %>
            <div class="chat-thread-shell w-100">
              <!-- Subscribe THIS viewer to this conversation -->
              <%= turbo_stream_from [:conversation, @open_conversation.id, :user, current_user.id] %>

              <%# ---------- Name to display depending on who is viewing ---------- %>
              <% header_name =
                   if current_user == @open_conversation.seller
                     @open_conversation.buyer&.full_name.presence ||
                     @open_conversation.buyer&.email.presence ||
                     "Buyer"
                   else
                     @open_conversation.seller&.estate_agent_name.presence ||
                     @open_conversation.seller&.full_name.presence ||
                     @open_conversation.seller&.email.presence ||
                     "Seller"
                   end %>

              <!-- Header -->
              <div class="chat-thread-head">
                <div class="d-flex align-items-center gap-2">
                  <div class="avatar-circle-sm"><i class="bi bi-person-fill"></i></div>
                  <div>
                    <div class="fw-semibold"><%= header_name %></div>

                    <% if @open_conversation.listing %>
                      <div class="small text-muted">
                        About:
                        <%= link_to @open_conversation.listing.title,
                                    listing_path(@open_conversation.listing),
                                    class: "text-decoration-none" %>
                      </div>
                    <% end %>
                  </div>
                </div>

                <% if @open_conversation.listing %>
                  <%= link_to listing_path(@open_conversation.listing), class: "btn btn-sm btn-ghost" do %>
                    <i class="bi bi-box-arrow-up-right me-1"></i> Open listing
                  <% end %>
                <% end %>
              </div>

              <!-- Body (scrolls + auto-scrolls on stream appends) -->
              <div class="chat-body"
                   id="chatBody_<%= @open_conversation.id %>"
                   data-controller="chat-autoscroll"
                   data-chat-autoscroll-target-id-value="messages_list_<%= @open_conversation.id %>">

                <% if @open_conversation.listing.present? %>
                  <div class="mb-3">
                    <%= render "conversations/listing_preview",
                               listing: @open_conversation.listing,
                               size: :sm %>
                  </div>
                <% end %>

                <div id="messages_list_<%= @open_conversation.id %>" class="chat-stream">
                  <%= render partial: "messages/message",
                             collection: @messages,
                             as: :message,
                             locals: { viewer_id: current_user.id } %>
                </div>

                <!-- Typing indicator slot -->
                <div id="typing_<%= @open_conversation.id %>" class="typing-slot" aria-live="polite"></div>
              </div>

              <!-- Composer (Enter to send, clears immediately, stays focused) -->
              <div class="chat-composer">
                <%= form_with url: conversation_messages_path(@open_conversation),
                              method: :post,
                              data: {
                                turbo: true,
                                controller: "chatinput",
                                chatinput_conversation_id_value: @open_conversation.id,  # pass convo id to Stimulus
                                action: "turbo:submit-start->chatinput#afterSubmitStart turbo:submit-end->chatinput#afterSubmitEnd"
                              },
                              class: "composer-shell" do %>
                  <div class="composer-input">
                    <button type="button" class="composer-icon" title="Aa"><i class="bi bi-type"></i></button>

                    <%= hidden_field_tag :redirect_to,
                          dashboard_path(tab: "buying",
                                         anchor: "messages",
                                         conversation_id: @open_conversation.id) %>

                    <%= text_area_tag "message[body]", nil,
                          rows: 1,
                          autocomplete: "off",
                          class: "composer-textarea",
                          placeholder: "Write your message…",
                          data: {
                            chatinput_target: "textarea",
                            action: "input->chatinput#typing input->chatinput#input keydown->chatinput#keydown"
                          } %>

                    <button class="composer-send"
                            type="submit"
                            data-chatinput-target="submit"
                            title="Send">
                      <i class="bi bi-send"></i>
                    </button>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="d-flex w-100 align-items-center justify-content-center text-muted" style="height: 60vh;">
              Select a chat on the left, or start one from a property page.
            </div>
          <% end %>
        </section>
      </div>
    </div>
  </div>
</div>
<!-- =================== /Contacts & Messages =================== -->
</div>
        
      </div> <!-- /col-lg-8 -->
    </div> <!-- /row -->

  <%# ====================== SELLING TAB ====================== %>
  <% else %>
    <% if has_approved %>
      <div class="row g-4 mb-4">
        <div class="col-6 col-lg-3">
          <div class="dashboard-card card h-100">
            <div class="kpi-card">
              <div class="kpi-value"><%= @stats[:active_listings] %></div>
              <div class="kpi-label">Active Listings</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="dashboard-card card h-100">
            <div class="kpi-card">
              <div class="kpi-value"><%= @stats[:unread_messages] %></div>
              <div class="kpi-label">Unread Messages</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="dashboard-card card h-100">
            <div class="kpi-card">
              <div class="kpi-value"><%= @stats[:upcoming_viewings] %></div>
              <div class="kpi-label">Upcoming Viewings</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="dashboard-card card h-100">
            <div class="kpi-card">
              <div class="kpi-value"><%= @stats[:this_month_views] %></div>
              <div class="kpi-label">Views This Month</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-8">
          <div class="dashboard-card card h-100">
            <div class="dashboard-card-header">
              <span><i class="bi bi-lightning me-2"></i> Quick Actions</span>
            </div>
            <div class="dashboard-card-body">
              <div class="row g-3">
                <div class="col-sm-6 col-md-3">
                  <%= link_to new_seller_listing_path, class: "btn btn-outline-dark w-100 h-100 py-3 d-flex flex-column align-items-center" do %>
                    <i class="bi bi-plus-circle fs-2 mb-2"></i>
                    <span>New Listing</span>
                  <% end %>
                </div>
                <div class="col-sm-6 col-md-3">
                  <%= link_to seller_listings_path, class: "btn btn-outline-dark w-100 h-100 py-3 d-flex flex-column align-items-center" do %>
                    <i class="bi bi-list-check fs-2 mb-2"></i>
                    <span>Manage Listings</span>
                  <% end %>
                </div>
                <div class="col-sm-6 col-md-3">
                  <%= link_to "#", class: "btn btn-outline-dark w-100 h-100 py-3 d-flex flex-column align-items-center" do %>
                    <i class="bi bi-inbox fs-2 mb-2"></i>
                    <span>Inbox</span>
                  <% end %>
                </div>
                <div class="col-sm-6 col-md-3">
                  <%= link_to "#", class: "btn btn-outline-dark w-100 h-100 py-3 d-flex flex-column align-items-center" do %>
                    <i class="bi bi-calendar-event fs-2 mb-2"></i>
                    <span>Viewings</span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="dashboard-card card h-100">
            <div class="dashboard-card-header">
              <span><i class="bi bi-credit-card me-2"></i> Billing</span>
            </div>
            <div class="dashboard-card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Plan:</span>
                <strong class="text-snoofly-primary"><%= @billing_overview[:plan] %></strong>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Next invoice:</span>
                <span><%= @billing_overview[:next_invoice_on] || "—" %></span>
              </div>
              <div class="d-flex justify-content-between align-items-center mb-4">
                <span class="text-muted">Amount:</span>
                <strong><%= @billing_overview[:amount] %></strong>
              </div>
              <%= link_to "Manage Subscription", "#", class: "btn btn-outline-dark w-100" %>
            </div>
          </div>
        </div>
      </div>

    <% else %>
      <div class="dashboard-card card border-left-0 border-right-0 border-bottom-0 border-top border-snoofly-primary border-3">
        <div class="card-body p-5 text-center">
          <div class="bg-snoofly-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-4"
               style="width: 80px; height: 80px;">
            <i class="bi bi-lock-fill text-snoofly-primary fs-1"></i>
          </div>
          <h3 class="fw-bold mb-2">Seller Dashboard Locked</h3>
          <p class="text-muted mb-4">Post a new listing and get it approved to unlock selling tools and analytics.</p>
          <div class="d-flex gap-2 justify-content-center">
            <%= link_to "Create Your First Listing", new_seller_listing_path, class: "btn btn-snoofly px-4" %>
            <%= link_to "View My Listings", seller_listings_path, class: "btn btn-outline-dark px-4" %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</section>

<%# ====================== Estate Agent Onboarding Modal ====================== %>
<div class="modal fade" id="agentSwitchModal" tabindex="-1" aria-hidden="true"
     data-auto-show="<%= flash[:show_agent_form].present? %>">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header border-0">
        <h5 class="modal-title">Switch to <span class="text-snoofly-primary fw-bold">Estate Agent</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with url: switch_to_estate_agent_seller_account_path,
                    method: :patch,
                    local: true,
                    multipart: true do |f| %>
        <div class="modal-body pt-0">
          <% if current_user&.errors&.any? %>
            <div class="alert alert-danger">
              <strong>Please fix the following:</strong>
              <ul class="mb-0">
                <% current_user.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="row g-3">
            <div class="col-md-6">
              <%= f.label :estate_agent_name, "Agency / Trading Name", class: "form-label" %>
              <%= f.text_field :estate_agent_name, class: "form-control",
                               value: current_user&.estate_agent_name %>
            </div>

            <div class="col-md-6">
              <%= f.label :landline_phone, "Office Landline", class: "form-label" %>
              <%= f.telephone_field :landline_phone, class: "form-control",
                                    value: current_user&.landline_phone %>
            </div>

            <div class="col-md-6">
              <%= f.label :mobile_phone, "Mobile", class: "form-label" %>
              <%= f.telephone_field :mobile_phone, class: "form-control",
                                    value: current_user&.mobile_phone %>
            </div>

            <div class="col-md-6">
              <%= f.label :logo, "Agency Logo", class: "form-label" %>
              <%= f.file_field :logo, class: "form-control", accept: "image/*" %>
              <div class="form-text">PNG/JPG, square looks best.</div>
            </div>

            <div class="col-12"><hr></div>

            <div class="col-md-6">
              <%= f.label :office_address_line1, "Address line 1", class: "form-label" %>
              <%= f.text_field :office_address_line1, class: "form-control",
                               value: current_user&.office_address_line1 %>
            </div>

            <div class="col-md-6">
              <%= f.label :office_address_line2, "Address line 2", class: "form-label" %>
              <%= f.text_field :office_address_line2, class: "form-control",
                               value: current_user&.office_address_line2 %>
            </div>

            <div class="col-md-4">
              <%= f.label :office_city, "City", class: "form-label" %>
              <%= f.text_field :office_city, class: "form-control",
                               value: current_user&.office_city %>
            </div>

            <div class="col-md-4">
              <%= f.label :office_county, "County", class: "form-label" %>
              <%= f.text_field :office_county, class: "form-control",
                               value: current_user&.office_county %>
            </div>

            <div class="col-md-4">
              <%= f.label :office_postcode, "Postcode", class: "form-label" %>
              <%= f.text_field :office_postcode, class: "form-control",
                               value: current_user&.office_postcode %>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit "Confirm & Switch", class: "btn btn-snoofly px-4" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function initDashboardUI() {
    // Buyer profile edit toggles
    const editBtn   = document.getElementById("editBuyerBtn");
    const readView  = document.getElementById("buyerReadView");
    const editForm  = document.getElementById("buyerEditForm");
    const cancelBtn = document.getElementById("cancelBuyerEdit");

    if (editBtn && readView && editForm) {
      editBtn.addEventListener("click", () => {
        readView.classList.add("d-none");
        editForm.classList.remove("d-none");
      });
    }
    if (cancelBtn && readView && editForm) {
      cancelBtn.addEventListener("click", () => {
        editForm.classList.add("d-none");
        readView.classList.remove("d-none");
      });
    }

    // Enable Bootstrap tooltips
    const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

    // Auto-open agent modal if server flagged it
    const modalEl = document.getElementById("agentSwitchModal");
    if (modalEl && modalEl.dataset.autoShow === "true") {
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    }
  }

  document.addEventListener("turbo:load", initDashboardUI);
  document.addEventListener("turbo:render", initDashboardUI);
</script>